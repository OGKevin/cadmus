name: Copilot Setup Steps

on:
  workflow_call:
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    name: Prepare Copilot Agent Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        id: rust-toolchain
        with:
          components: rustfmt, clippy
          targets: arm-unknown-linux-gnueabihf

      - name: Cache Cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ steps.rust-toolchain.outputs.cachekey }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache thirdparty libraries (Kobo cross-compile)
        uses: actions/cache@v5
        with:
          path: |
            libs/
            thirdparty/
            mupdf_wrapper/
          key: ${{ runner.os }}-thirdparty-libs-kobo-${{ hashFiles('thirdparty/download.sh', 'thirdparty/**/build-kobo.sh', 'thirdparty/**/*.patch') }}

      - name: Cache thirdparty libraries (native testing)
        uses: actions/cache@v5
        with:
          path: |
            thirdparty/mupdf
            mupdf_wrapper/
          key: ${{ runner.os }}-thirdparty-libs-native-${{ hashFiles('thirdparty/download.sh') }}

      - name: Cache Linaro toolchain
        id: cache-linaro
        uses: actions/cache@v5
        with:
          path: ~/linaro-toolchain
          key: linaro-gcc-4.9.4-2017.01

      - name: Cache NickelMenu downloads
        uses: actions/cache@v5
        with:
          path: .cache/
          key: ${{ runner.os }}-nickelmenu-${{ hashFiles('bundle.sh') }}

      - name: Install system packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: git wget curl pkg-config gcc g++ make cmake meson ninja-build autoconf automake libtool gperf python3 zlib1g-dev libbz2-dev libpng-dev libjpeg-dev libopenjp2-7-dev libjbig2dec0-dev libgumbo-dev libfreetype6-dev libharfbuzz-dev libdjvulibre-dev libsdl2-dev shellcheck zip unzip ca-certificates jq patchelf
          version: 1.0

      - name: Download Linaro toolchain
        if: steps.cache-linaro.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/linaro-toolchain
          cd ~/linaro-toolchain
          wget -q https://releases.linaro.org/components/toolchain/binaries/4.9-2017.01/arm-linux-gnueabihf/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf.tar.xz
          tar xf gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf.tar.xz --strip-components=1
          rm gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf.tar.xz

      - name: Setup Linaro toolchain
        run: |
          echo "$HOME/linaro-toolchain/bin" >> $GITHUB_PATH

      - name: Download thirdparty dependencies
        run: |
          # Download all thirdparty sources if not cached
          cd thirdparty
          for lib in zlib bzip2 libpng libjpeg openjpeg jbig2dec freetype2 harfbuzz gumbo djvulibre mupdf; do
            if [ ! -d "$lib" ]; then
              ./download.sh "$lib"
            fi
          done
          cd ..

      - name: Setup native dependencies for testing
        env:
          TEST_ROOT_DIR: ${{ github.workspace }}
        run: |
          # Build mupdf wrapper for Linux (required for cargo test)
          cd mupdf_wrapper
          ./build.sh
          cd ..

          # Build MuPDF for native development using system libraries
          cd thirdparty/mupdf
          [ -e .gitattributes ] && rm -rf .git*

          # Clean any previous builds
          make clean || true

          # Generate sources
          make verbose=yes generate

          # Build MuPDF libraries using system libraries
          make verbose=yes \
            mujs=no tesseract=no extract=no archive=no brotli=no barcode=no commercial=no \
            USE_SYSTEM_LIBS=yes \
            XCFLAGS="-DFZ_ENABLE_ICC=0 -DFZ_ENABLE_SPOT_RENDERING=0 -DFZ_ENABLE_ODT_OUTPUT=0 -DFZ_ENABLE_OCR_OUTPUT=0" \
            libs

          cd ../..

          # Create target directory structure
          mkdir -p target/mupdf_wrapper/Linux

          # Copy libmupdf.a
          ln -sf "$(pwd)/thirdparty/mupdf/build/release/libmupdf.a" target/mupdf_wrapper/Linux/

          # Create empty libmupdf-third.a (system libs used instead)
          if [ ! -e thirdparty/mupdf/build/release/libmupdf-third.a ]; then
            ar cr thirdparty/mupdf/build/release/libmupdf-third.a
          fi
          ln -sf "$(pwd)/thirdparty/mupdf/build/release/libmupdf-third.a" target/mupdf_wrapper/Linux/

      - name: Verify installation
        run: |
          rustc --version || true
          cargo --version || true
          cargo fmt --version || true
          cargo clippy --version || true
          arm-linux-gnueabihf-gcc --version || true
          # Verify native test setup
          ls -la target/mupdf_wrapper/Linux/ || true
